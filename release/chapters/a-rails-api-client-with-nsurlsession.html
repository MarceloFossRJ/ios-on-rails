<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>iOS on Rails (Beta): A Rails API Client With NSURLSession</title>
  <style type="text/css"><![CDATA[code{white-space: pre;}]]></style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="data:text/css,%2A%20%7B%0A%20%20%2Dmoz%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0A%20%20%2Dwebkit%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0A%20%20box%2Dsizing%3A%20border%2Dbox%3B%20%7D%0A%0Abody%20%7B%0A%20%20font%2Dsize%3A%201em%3B%0A%20%20height%3A%20100%25%3B%0A%20%20margin%3A%200%20auto%3B%0A%20%20max%2Dwidth%3A%2054em%3B%0A%20%20padding%3A%200%201em%204%2E5em%3B%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%204em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20700px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20font%2Dsize%3A%201%2E125em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20800px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%206em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20880px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%208em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20940px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%2010em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%201800px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20font%2Dsize%3A%201%2E375em%3B%20%7D%20%7D%0A%0Anav%20%7B%0A%20%20border%2Dbottom%3A%201px%20dashed%20%23dddddd%3B%0A%20%20border%2Dtop%3A%201px%20dashed%20%23dddddd%3B%0A%20%20padding%3A%201%2E5em%200%3B%0A%20%20margin%3A%201%2E5em%200%3B%20%7D%0A%20%20nav%20%3E%20ul%20%3E%20li%20%3E%20a%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%20%7D%0A%0Aheader%20%7B%0A%20%20padding%3A%204%2E5em%200%3B%20%7D%0A%0Abody%20%7B%0A%20%20%2Dwebkit%2Dfont%2Dsmoothing%3A%20antialiased%3B%0A%20%20color%3A%20%23444444%3B%0A%20%20font%2Dfamily%3A%20%22proxima%2Dnova%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20line%2Dheight%3A%201%2E5em%3B%20%7D%0A%0Ah1%2C%20h2%2C%20h3%2C%20h4%2C%20h5%2C%20h6%20%7B%0A%20%20color%3A%20%23222222%3B%0A%20%20font%2Dfamily%3A%20%22proxima%2Dnova%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20line%2Dheight%3A%201%2E25em%3B%0A%20%20margin%3A%201%2E5em%200%200%2E375em%3B%0A%20%20text%2Drendering%3A%20optimizeLegibility%3B%20%7D%0A%20%20h1%20%3E%20a%2C%20h2%20%3E%20a%2C%20h3%20%3E%20a%2C%20h4%20%3E%20a%2C%20h5%20%3E%20a%2C%20h6%20%3E%20a%20%7B%0A%20%20%20%20color%3A%20%23222222%3B%20%7D%0A%0Ah1%20%7B%0A%20%20margin%3A%203em%200%200%2E375em%3B%0A%20%20font%2Dsize%3A%201%2E75em%3B%20%7D%0A%20%20h1%20%3E%20a%20%7B%0A%20%20%20%20color%3A%20%23c32f34%3B%20%7D%0A%20%20%20%20h1%20%3E%20a%3Ahover%2C%20h1%20%3E%20a%3Afocus%20%7B%0A%20%20%20%20%20%20color%3A%20%23222222%3B%20%7D%0A%20%20h1%2Etitle%20%7B%0A%20%20%20%20font%2Dsize%3A%203em%3B%0A%20%20%20%20font%2Dweight%3A%20900%3B%0A%20%20%20%20line%2Dheight%3A%201%3B%0A%20%20%20%20margin%3A%200%200%20%2E125em%3B%20%7D%0A%20%20%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20%20%20h1%2Etitle%20%7B%0A%20%20%20%20%20%20%20%20font%2Dsize%3A%204em%3B%20%7D%20%7D%0A%0Ah2%20%7B%0A%20%20font%2Dsize%3A%201em%3B%0A%20%20letter%2Dspacing%3A%201px%3B%0A%20%20text%2Dtransform%3A%20uppercase%3B%20%7D%0A%20%20h2%2Eauthor%20%7B%0A%20%20%20%20color%3A%20%23999999%3B%0A%20%20%20%20float%3A%20left%3B%0A%20%20%20%20font%2Dsize%3A%201em%3B%0A%20%20%20%20font%2Dweight%3A%20200%3B%0A%20%20%20%20margin%3A%200%3B%0A%20%20%20%20text%2Dtransform%3A%20none%3B%20%7D%0A%20%20%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20%20%20h2%2Eauthor%20%7B%0A%20%20%20%20%20%20%20%20font%2Dsize%3A%201%2E25em%3B%20%7D%20%7D%0A%20%20%20%20h2%2Eauthor%3Anot%28%3Alast%2Dchild%29%20%7B%0A%20%20%20%20%20%20margin%2Dright%3A%201em%3B%20%7D%0A%0Ah3%20%7B%0A%20%20font%2Dsize%3A%201em%3B%20%7D%0A%0Ah4%20%7B%0A%20%20font%2Dsize%3A%201%2E5em%3B%20%7D%0A%0Ah5%20%7B%0A%20%20font%2Dsize%3A%201%2E25em%3B%20%7D%0A%0Ah6%20%7B%0A%20%20font%2Dsize%3A%201em%3B%20%7D%0A%0Ap%20%7B%0A%20%20margin%3A%200%200%200%2E75em%3B%20%7D%0A%0Aa%20%7B%0A%20%20%2Dmoz%2Dtransition%3A%20all%200%2E15s%20ease%2Dout%200%3B%0A%20%20%2Dwebkit%2Dtransition%3A%20all%200%2E15s%20ease%2Dout%200%3B%0A%20%20color%3A%20%23477dca%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%20%20transition%3A%20all%200%2E15s%20ease%2Dout%200%3B%20%7D%0A%20%20a%3Ahover%20%7B%0A%20%20%20%20color%3A%20%232c5999%3B%20%7D%0A%20%20a%3Aactive%2C%20a%3Afocus%20%7B%0A%20%20%20%20color%3A%20%232c5999%3B%0A%20%20%20%20outline%3A%20none%3B%20%7D%0A%0Ahr%20%7B%0A%20%20border%3A%20none%3B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23dddddd%3B%0A%20%20margin%3A%201%2E5em%200%3B%20%7D%0A%0Aimg%20%7B%0A%20%20margin%3A%200%3B%0A%20%20max%2Dwidth%3A%20100%25%3B%20%7D%0A%0Acode%20%7B%0A%20%20font%2Dfamily%3A%20inconsolata%2C%20%22Bitstream%20Vera%20Sans%20Mono%22%2C%20Consolas%2C%20Courier%2C%20monospace%3B%0A%20%20font%2Dsize%3A%20%2E875em%3B%0A%20%20white%2Dspace%3A%20pre%3B%0A%20%20word%2Dwrap%3A%20break%2Dword%3B%20%7D%0A%0Apre%20%7B%0A%20%20background%3A%20%23f7f7f7%3B%0A%20%20border%3A%201px%20solid%20%23dddddd%3B%0A%20%20line%2Dheight%3A%201%2E35%3B%0A%20%20overflow%2Dx%3A%20scroll%3B%0A%20%20padding%3A%20%2E5rem%201rem%3B%0A%20%20white%2Dspace%3A%20pre%3B%0A%20%20word%2Dwrap%3A%20normal%3B%20%7D%0A%20%20pre%20code%20%7B%0A%20%20%20%20word%2Dwrap%3A%20normal%3B%20%7D%0A%0Ablockquote%20%7B%0A%20%20border%2Dleft%3A%202px%20solid%20%23dddddd%3B%0A%20%20color%3A%20%236a6a6a%3B%0A%20%20margin%3A%201%2E5em%200%3B%0A%20%20padding%2Dleft%3A%200%2E75em%3B%20%7D%0A" rel="stylesheet" />
  <script type="text/javascript"><![CDATA[
    (function() {
      var config = {
        kitId: 'bgd6ksj',
        scriptTimeout: 3000
      };
      var h=document.getElementsByTagName("html")[0];h.className+=" wf-loading";var t=setTimeout(function(){h.className=h.className.replace(/(\s|^)wf-loading(\s|$)/g," ");h.className+=" wf-inactive"},config.scriptTimeout);var tk=document.createElement("script"),d=false;tk.src='//use.typekit.net/'+config.kitId+'.js';tk.type="text/javascript";tk.async="true";tk.onload=tk.onreadystatechange=function(){var a=this.readyState;if(d||a&&a!="complete"&&a!="loaded")return;d=true;clearTimeout(t);try{Typekit.load(config)}catch(b){}};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(tk,s)
    })();
  ]]></script>
</head>
<body><section id="a-rails-api-client-with-nsurlsession" class="level1">
<h1>A Rails API Client With NSURLSession</h1>
<p>Before we go about making our first API request, we need to decide how we are going to make our networking calls. As mentioned in the Cocoapods chapter, the AFNetworking framework is a clean and reliable solution to making networking requests. We will show examples of using AFNetworking to make your API requests as well as examples of making requests using the built-in <code>NSURLSession</code>, which all networking libraries are built on top of. AFNetworking brings a lot more to the table than just wrapping up your network requests; but, like a programming planeteer, the choice is yours.</p>
<section id="creating-a-singleton-client-object" class="level3">
<h3>Creating a Singleton Client Object</h3>
<p>Create a subclass of <code>NSObject</code> called <code>HUMRailsClient</code>. All of our API requests will be handled by one instance of the <code>HUMRailsClient</code>, so we're going to create a singleton of <code>HUMRailsClient</code>.</p>
<p>What we will create and refer to as a singleton isn't a dictionary-definition singleton, since we aren't completely limiting the instantiation of HUMRailsClient to only one object. We are, however, limiting the instantiation of HUMRailsClient to only one object if we always use our sharedClient. Essentially, our sharedClient is a singleton if we use it consistently but it is not if we errantly decide to instantiate another instance of HUMRailsClient using <code>[[HUMRailsClient alloc] init]</code>.</p>
<p>Declare a class method that will return our singleton by adding <code>+ (instancetype)sharedClient;</code> to your <code>HUMRailsClient.h</code> file. We use <code>instancetype</code> as our return type to indicate that this class method will return an instance of <code>HUMRailsClient</code>. The + indicates that <code>sharedClient</code> is a class method to be called directly on the <code>HUMRailsClient</code> class. Prepending your class method with "shared" indicates to other developers that the method returns a singleton.</p>
<p>Now let's implement this method:</p>
<pre><code>// HUMRailsClient.m

+ (instancetype)sharedClient
{
    static HUMRailsClient *_sharedClient = nil;
    
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
    
        // Code to be run only once
        _sharedClient = [[HUMRailsClient alloc] init];
        
    });

    return _sharedClient;
}</code></pre>
<p>First, we declare a static variable of type <code>HUMRailsClient</code>. Since it's a static variable, <code>_sharedClient</code> will last for the life of the program.</p>
<p>Then, we use Grand Central Dispatch to execute a block of code once and only once. If you are using Xcode and begin typing <code>dispatch_once</code>, you can even use autocomplete to find and insert the entire <code>dispatch_once</code> code snippet. <code>dispatch_once</code> takes a reference to a static variable of type <code>dispatch_once_t</code> and a block of code to execute. <code>dispatch_once_t</code> is a long variable type that indicates whether the block of code has already been executed. On the first call of <code>dispatch_once</code>, the <code>onceToken</code> is set and the block executed, but on every subsequent call the block is not executed because the onceToken has already been set.</p>
<p>Inside the block we instantiate a <code>HUMRailsClient</code> and set it as the value of the static variable <code>_sharedClient</code>. Once that is done, we simply need to return our singleton <code>_sharedClient</code>.</p>
</section>
<section id="creating-a-session-for-handling-requests" class="level3">
<h3>Creating a Session for Handling Requests</h3>
<p>iOS 7 introduced the <code>NSURLSession</code> class, which is an object that handles groups of HTTP requests. Each API request we make in a NSURLSession is encapsulated in a <code>NSURLSessionTask</code>, which executes the request asynchronously and notifies you of completion by executing a block or by calling a method on its delegate.</p>
<p>There are three different types of <code>NSURLSession</code> objects, including one that allows your app to continue downloading data even if the app is in the background. The type of a session is determined by its <code>sessionConfiguration</code>, but for simple API requests we only need to use the default session type.</p>
<p>Declare a session property and a static app secret string above your <code>@implementation</code> inside <code>HUMRailsClient.m</code>.</p>
<pre><code>// HUMRailsClient.m

static NSString *const HUMAppSecret =
    @"yourOwnUniqueAppSecretThatYouShouldRandomlyGenerateAndKeepSecret";

@interface HUMRailsClient ()

@property (strong, nonatomic) NSURLSession *session;

@end</code></pre>
<p>We will use the <code>HUMAppSecret</code> to sign POST requests to /users so the backend can validate that the request is coming from our mobile app. The session object will handle all of our API requests.</p>
<p>We want our <code>HUMRailsClient</code> to always have a session object, so we will overwrite the <code>HUMRailsClient</code>'s <code>-init</code> method to set the client's <code>session</code> property.</p>
<p>Custom init methods all have the same general format:</p>
<pre><code>- (instancetype)init
{
    self = [super init];
    if (!self) { 
        return nil; 
    }
    // Do custom init stuff.
    return self;
}</code></pre>
<p>So, our <code>HUMRailsClient</code>'s custom <code>-init</code> method will look like:</p>
<pre><code>// HUMRailsClient.m

- (instancetype)init
{
    self = [super init];
    
    if (!self) {
        return nil;
    }
    
    NSURLSessionConfiguration *sessionConfiguration =
        [NSURLSessionConfiguration defaultSessionConfiguration];
    sessionConfiguration.timeoutIntervalForRequest = 30.0;
    sessionConfiguration.timeoutIntervalForResource = 30.0;
    
    _session = [NSURLSession sessionWithConfiguration:sessionConfiguration];
    
    return self;
}
    </code></pre>
<p>This custom <code>-init</code> method first creates a <code>sessionConfiguration</code>. We could just use the default <code>NSURLSessionConfiguration</code> that is returned from <code>NSURLSessionConfiguration</code>'s class method <code>defaultSessionConfiguration</code> to create our <code>NSURLSession</code>. However, we also want to change our timeout properties to 30 seconds and add some HTTP headers.</p>
<p>Next, we use that <code>sessionConfiguration</code> to create an <code>NSURLSession</code>, and set that session as the <code>_session</code> property on our singleton.</p>
</section>
<section id="setting-the-session-headers" class="level3">
<h3>Setting the Session Headers</h3>
<p>Setting the session headers on the <code>sessionConfiguration</code> is particularly important, since sending the app secret and a token is necessary for user creation, and a token is necessary for all other requests.</p>
<pre><code>// HUMRailsClient.m

- (instancetype)init
{
    ...
    
    NSDictionary *headers = @{
          @"Accept" : @"application/json",
          @"Content-Type" : @"application/json",
          @"tb-device-token" : [[NSUUID UUID] UUIDString],
          @"tb-app-secret" : HUMAppSecret
          };
    [sessionConfiguration setHTTPAdditionalHeaders:headers];
    
    _session = [NSURLSession sessionWithConfiguration:sessionConfiguration];
    
    return self;
}</code></pre>
<p>Our custom session headers indicate that our content type is JSON and set the token and app secret. These are the headers that we need for a POST to the users endpoint. For requests other than that we will only need the token.</p>
<p>Currently, we are using a client generated device ID as our token, but our plan is to eventually replace that with an auth token generated by the backend.</p>
</section>
</section></body>
</html>
